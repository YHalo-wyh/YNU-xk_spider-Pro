# 迁移指南 - 从旧版本升级到安全优先版

## 版本信息
- **旧版本**: 带盲抢功能的版本
- **新版本**: 安全优先版 v2.0
- **升级日期**: 2026-01-16

---

## 🔄 主要变化

### 1. 行为变化

#### 盲抢功能已移除
**旧版本**:
- 查询失败时会尝试盲抢
- 可能误选不需要的课程

**新版本**:
- 查询失败时直接跳过
- 更加保守和安全

**影响**: 
- ✅ 更安全，不会误选
- ⚠️ 可能错过极少数机会（但这些机会本身就不确定）

---

#### 幽灵余量防御
**新增功能**:
- 系统会检查 `isFull` 字段
- 即使显示有余量，如果 `isFull=True` 也会跳过

**影响**:
- ✅ 保护已选课程不被误退
- ⚠️ 可能跳过一些"看起来有余量"的课程（但这些余量是假的）

---

#### 回滚机制增强
**旧版本**:
- 换课失败后仅尝试1次回滚
- 回滚失败则放弃

**新版本**:
- 换课失败后进入5分钟紧急救援模式
- 持续高频重试直到成功或超时

**影响**:
- ✅ 大幅降低丢课风险
- ⚠️ 紧急救援期间会有较多请求（但有心跳维持，不会假死）

---

## 📋 升级步骤

### 步骤 1: 备份
```bash
# 备份旧版本文件
copy xk_spider\gui\workers.py xk_spider\gui\workers.py.backup
```

### 步骤 2: 更新代码
- 直接使用新版本的 `workers.py` 文件
- 无需修改其他文件

### 步骤 3: 测试
1. 启动程序
2. 登录账号
3. 添加测试课程
4. 观察日志输出

### 步骤 4: 验证
检查以下功能是否正常:
- ✅ 登录功能
- ✅ 课程查询
- ✅ 余量监控
- ✅ 自动选课
- ✅ 自动换课

---

## 🔍 兼容性检查

### API 兼容性
✅ 所有 API 调用保持不变
- `_api_query_course_capacity`
- `_api_select_course_fast`
- `_api_delete_course`
- `_api_get_selected_courses`

### UI 兼容性
✅ 所有信号和槽保持不变
- `success` 信号
- `failed` 信号
- `status` 信号
- `need_relogin` 信号
- `course_available` 信号
- `heartbeat` 信号

### 配置兼容性
✅ 所有配置项保持不变
- `config.json` 无需修改
- 用户设置无需修改

---

## 📊 性能影响

### 正常监控
- **CPU**: 无明显变化
- **内存**: 无明显变化
- **网络**: 无明显变化

### 紧急救援模式（仅在换课失败时触发）
- **CPU**: 轻微增加（心跳维持）
- **内存**: 无明显变化
- **网络**: 增加（0.7秒间隔的重试请求）
- **持续时间**: 最多5分钟

---

## ⚠️ 注意事项

### 1. 日志文件可能变大
新版本增加了更多安全日志，日志文件可能增长更快

**建议**: 定期清理 `logs/run.log`

### 2. 紧急救援期间的UI响应
紧急救援模式下会有大量请求，但有心跳维持机制，UI不会假死

**正常现象**: 
- 状态栏频繁更新
- 日志快速滚动
- 心跳计数快速增加

### 3. 更保守的抢课策略
新版本更加保守，可能会跳过一些不确定的机会

**权衡**: 
- 安全性 ⬆️⬆️⬆️
- 激进性 ⬇️⬇️

---

## 🐛 常见问题

### Q1: 升级后为什么不抢课了？
**A**: 检查日志:
- 如果看到 `[GHOST]` → 系统检测到幽灵余量，保护你的课程
- 如果看到 `[SKIP]` → 查询失败，系统跳过以防误操作
- 如果看到 `[FAIL]` → 选课失败，查看具体原因

### Q2: 紧急救援模式会持续多久？
**A**: 最多5分钟，之后会自动停止并提示用户手动检查

### Q3: 可以恢复盲抢功能吗？
**A**: 不建议。盲抢功能存在误选风险，已被安全策略取代。如果确实需要，可以恢复备份文件。

### Q4: 如何调整回滚参数？
**A**: 编辑 `workers.py` 文件，找到 `_handle_conflict_rollback` 方法:
```python
DESPERATE_RECOVERY_DURATION = 300  # 改为你想要的秒数
RETRY_INTERVAL = 0.7  # 改为你想要的间隔（秒）
```

---

## 📞 回滚到旧版本

如果遇到严重问题，可以回滚:

```bash
# 恢复备份
copy xk_spider\gui\workers.py.backup xk_spider\gui\workers.py

# 重启程序
```

**注意**: 回滚后会失去所有安全特性

---

## 📈 升级建议

### 推荐升级场景
- ✅ 担心误退核心课程
- ✅ 需要更高的安全性
- ✅ 愿意牺牲少量激进性换取安全

### 暂缓升级场景
- ⚠️ 需要极致激进的抢课策略
- ⚠️ 服务器负载已经很高
- ⚠️ 正在选课高峰期（建议等待低峰期升级）

---

## 📝 升级检查清单

升级前:
- [ ] 备份 `workers.py` 文件
- [ ] 记录当前配置
- [ ] 导出已选课程列表

升级后:
- [ ] 测试登录功能
- [ ] 测试课程查询
- [ ] 测试余量监控
- [ ] 观察日志输出
- [ ] 验证心跳信号

确认无误:
- [ ] 删除备份文件
- [ ] 更新文档
- [ ] 通知用户

---

## 🎓 学习资源

- `REFACTORING_SUMMARY.md` - 详细的重构说明
- `SAFETY_FEATURES.md` - 安全特性说明
- `logs/run.log` - 运行日志（包含所有安全标识）

---

**升级支持**: 如遇问题，请查看日志文件并参考上述文档
**最后更新**: 2026-01-16
