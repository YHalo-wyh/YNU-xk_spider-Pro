# 抢课助手安全特性说明

## 🛡️ 三大核心安全机制

### 1. 零盲抢策略 (No Blind Grab)

**问题**: 查询失败时盲目抢课可能误选不需要的课程

**解决方案**:
```
查询失败 → 打印日志 → 跳过本次循环 → 继续下次查询
```

**日志标识**: `[SKIP]`

**示例**:
```
[SKIP] 高等数学 查询失败，跳过本次循环（安全模式）
```

---

### 2. 幽灵余量防御 (Ghost Capacity Defense)

**问题**: 系统显示有余量但实际已满（数据延迟），抢课会导致冲突并误退旧课

**解决方案**:
```
检查顺序:
1. 首先检查 isFull 字段（系统标记）
2. 如果 isFull=True，即使 remain>0 也跳过
3. 仅当 isFull=False 且 remain>0 时才抢课
```

**日志标识**: `[GHOST]`

**示例**:
```
[GHOST] 大学物理 显示余量3但isFull=True，跳过以防误退课（幽灵余量）
```

---

### 3. 亡命回滚机制 (Desperate Recovery)

**问题**: 换课时退掉旧课但抢新课失败，导致旧课丢失

**解决方案**:
```
换课失败 → 进入紧急救援模式 → 5分钟持续抢回旧课
- 重试间隔: 0.7秒
- 持续时间: 5分钟
- 心跳维持: 防止UI假死
```

**日志标识**: `[紧急救援]`

**示例**:
```
[紧急救援] 🚨 开始死磕回滚 线性代数，持续5分钟...
[紧急救援] 🔄 第23次尝试抢回 线性代数 (剩余267秒)
[紧急救援] ✓ 成功抢回 线性代数！(尝试45次)
```

---

## 📊 安全等级对比

| 场景 | 旧版本 | 新版本 | 风险降低 |
|------|--------|--------|----------|
| 查询失败 | 盲抢（高风险） | 跳过（零风险） | ⬇️ 100% |
| 幽灵余量 | 直接抢（误退风险） | 跳过（零风险） | ⬇️ 100% |
| 换课失败 | 1次回滚（丢课风险） | 5分钟死磕（极低风险） | ⬇️ 95% |

---

## 🎯 使用建议

### 正常使用
- 系统会自动应用所有安全机制
- 无需手动配置
- 关注日志中的 `[GHOST]`、`[SKIP]`、`[紧急救援]` 标识

### 日志解读

#### ✅ 安全跳过
```
[SKIP] 课程名 查询失败，跳过本次循环（安全模式）
→ 正常，系统保护你不盲抢
```

#### ⚠️ 幽灵余量
```
[GHOST] 课程名 显示余量X但isFull=True，跳过以防误退课
→ 正常，系统保护你的已选课程
```

#### 🚨 紧急救援
```
[紧急救援] 开始死磕回滚 课程名，持续5分钟...
→ 换课失败，系统正在拼命抢回旧课，请耐心等待
```

#### 🎉 成功信号
```
[紧急救援] ✓ 成功抢回 课程名！(尝试X次)
→ 旧课已抢回，安全！
```

---

## ⚙️ 高级参数（开发者）

### 回滚参数调整
位置: `workers.py` → `_handle_conflict_rollback` 方法

```python
DESPERATE_RECOVERY_DURATION = 300  # 5分钟，可调整
RETRY_INTERVAL = 0.7  # 0.7秒间隔，可调整
```

**调整建议**:
- 服务器负载低 → 可减小 `RETRY_INTERVAL` 至 0.5秒
- 服务器负载高 → 可增大 `RETRY_INTERVAL` 至 1.0秒
- 网络不稳定 → 可增大 `DESPERATE_RECOVERY_DURATION` 至 600秒（10分钟）

---

## 🔍 故障排查

### Q: 为什么有余量但不抢？
A: 检查日志是否有 `[GHOST]` 标识，系统检测到幽灵余量，保护你的已选课程

### Q: 换课失败后一直在重试？
A: 正常，系统进入紧急救援模式，最多持续5分钟，请耐心等待

### Q: 查询失败后为什么不尝试抢课？
A: 安全策略，查询失败时不确定课程状态，跳过以防误操作

---

## 📞 技术支持

如遇问题，请提供:
1. 完整日志文件 (`logs/run.log`)
2. 问题发生时间
3. 涉及的课程名称
4. 日志中的关键标识（`[GHOST]`、`[SKIP]`、`[紧急救援]`）

---

**最后更新**: 2026-01-16
**版本**: 安全优先版 v2.0
