# 🚀 YNU选课助手 Pro v1.5.0

## ✨ 重大更新：稳定性大幅提升 + 智能监控

本次更新彻底解决了长时间运行卡死和闪退问题，新增智能健康检查和自动恢复系统。

---

## 🛡️ 核心改进

### 增强版健康检查系统
- **4层检测机制**
  - 第1层：活动时间检测（2分钟警告，5分钟启动恢复）
  - 第2层：请求计数检测（防止假活动和死循环）
  - 第3层：线程状态检测（检测卡死的监控线程）
  - 第4层：定期健康报告（每10分钟状态汇报）

### 智能自动恢复
检测到卡死后自动执行4步恢复流程：
1. 🔍 网络连接检测 - 确保网络可达性
2. 🔐 登录状态验证 - 自动重新登录过期会话
3. 🧹 状态重置清理 - 清理卡死的监控状态
4. 🧪 功能测试验证 - 确保恢复后正常工作

### 实时监控状态
- ⚠️ 2分钟无活动 → 发出警告
- 🚨 5分钟无活动 → 启动自动恢复
- 🆘 恢复失败3次 → 建议手动重启
- 📊 每10分钟 → 健康状态报告

---

## 🐛 稳定性修复

### 彻底解决3小时卡死问题
**根本原因**：
- Socket句柄泄漏：`terminate()` 强制终止线程导致连接未关闭
- GIL死锁：多线程 + 网络IO + UI更新导致死锁
- 连接池泄漏：HTTP连接未正确释放

**解决方案**：
- ✅ 使用 `requests.Session` 上下文管理器，自动释放连接
- ✅ 移除 `terminate()` 暴力终止，改用信号断开策略
- ✅ 添加健康检查机制，及时发现并恢复卡死状态

### 彻底解决登录后闪退问题
**根本原因**：
- 未处理的异常：网络请求缺少异常处理
- Session过期处理不当：继续使用无效token导致连锁错误
- UI线程阻塞：网络请求在UI线程执行导致假死

**解决方案**：
- ✅ 全面的异常处理，所有网络操作都有try-catch
- ✅ 智能Session过期检测和自动重登
- ✅ 所有网络操作后台化，避免阻塞UI

### 其他修复
- 修复：长时间运行后刷新课程列表卡死
- 修复：心跳机制异常处理，避免UI线程阻塞
- 修复：登录状态检测超时处理，防止程序卡死

---

## ⚡ 性能优化

- 优化：心跳信号发送频率（每10次或每5秒），减少跨线程通信
- 优化：日志框性能，超过500行自动清理到200行，避免长时间运行卡顿
- 优化：课程获取失败时显示"加载中"，连续3次失败后才显示错误提示
- 优化：独立的更新检查Worker，检查更新不再阻塞UI

---

## 🎯 新增功能

### 体育课程优化
- 自动解析体育项目名称（`sportName` 字段）
- 课程卡片显示格式：`教师名 -- 体育项目名`
- 示例：`罗斌 -- 排球（四）`、`杨孟庄 -- 羽毛球（四）`

### 健康监控
- 实时监控程序运行状态
- 自动检测并报告异常情况
- 智能恢复机制，最大化程序可用性

---

## 📦 下载

| 文件 | 说明 |
|------|------|
| `YNU选课助手Pro_Setup.exe` | 安装版，双击安装，自动创建桌面快捷方式 |
| `YNU选课助手Pro_Portable.zip` | 便携版，解压后直接运行 `YNU选课助手Pro.exe` |

---

## 🚀 使用说明

1. 下载安装版或便携版
2. 运行程序，输入学号密码登录
3. 浏览课程，点击「🎯 加入待抢」
4. 点击「▶ 开始监控」，程序自动检测余量并抢课
5. **新功能**：程序会自动检测和恢复卡死状态，无需手动干预

---

## 💡 使用建议

### 长时间运行
- 程序现在可以稳定运行6-8小时以上
- 健康检查系统会自动监控并恢复异常状态
- 如遇连续恢复失败，请检查网络连接

### 监控状态
- 注意观察日志中的健康检查报告
- 看到"⚠️ 监控活动减少"是正常预警
- 看到"✅ 自动恢复成功"说明系统已自动修复

---

## ⚠️ 注意事项

- 本工具仅用于辅助选课，请合理使用
- 新增的自动恢复功能会在检测到问题时自动修复
- 如遇到连续恢复失败，请检查网络连接或手动重启程序
- 建议在选课高峰期提前启动程序，确保稳定运行

---

## 🔗 相关链接

- **GitHub仓库**: https://github.com/YHalo-wyh/YNU-xk_spider-Pro
- **问题反馈**: https://github.com/YHalo-wyh/YNU-xk_spider-Pro/issues
- **更新日志**: https://github.com/YHalo-wyh/YNU-xk_spider-Pro/compare/v1.4.0...v1.5.0

---

**感谢使用 YNU选课助手 Pro！**
